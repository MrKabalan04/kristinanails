<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Admin Panel - Kristina Nails</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
body { background: #121212; color: #fff; min-height: 100vh; font-family: Arial, sans-serif; }
.navbar { background: #1a1a1a; }
.container { padding-top: 40px; padding-bottom: 40px; }
.card { background: #1e1e1e; border-radius: 12px; padding: 20px; margin-bottom: 20px; }
.btn-primary { background: #ff4d6d; border: none; }
.btn-primary:hover { background: #ff6b87; }
.modal-content { background: #1e1e1e; color: #fff; border-radius: 12px; }
input { background: #2a2a2a; color: #fff; border: 1px solid #444; border-radius: 8px; padding: 8px 12px; width: 100%; margin-bottom: 10px; }
table { color: #fff; }
th, td { vertical-align: middle !important; }
.btn-text { background: transparent; border: none; color: #ff4d6d; cursor: pointer; padding: 0 5px; }
.btn-text:hover { text-decoration: underline; }
@media(max-width:576px){
  .container { padding: 20px; }
  table { font-size: 14px; }
  .btn { font-size: 14px; }
}
</style>
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-dark">
  <div class="container">
    <a class="navbar-brand" href="#">Kristina Nails</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarNav">
      <ul class="navbar-nav ms-auto">
        <li class="nav-item"><a class="nav-link" href="admin-panel.html">Services</a></li>
        <li class="nav-item"><a class="nav-link" href="#">Categories</a></li>
        <li class="nav-item"><a class="nav-link" href="admin.html">Logout</a></li>
      </ul>
    </div>
  </div>
</nav>

<div class="container">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2>Manage Categories</h2>
    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#categoryModal">+ Add Category</button>
  </div>

  <div class="table-responsive">
    <table class="table table-dark table-striped" id="categoriesTable">
      <thead>
        <tr>
          <th>Name</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<!-- Add/Edit Category Modal -->
<div class="modal fade" id="categoryModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content p-4">
      <h5 id="modalTitle">Add Category</h5>
      <input type="hidden" id="categoryId">
      <input type="text" id="categoryName" placeholder="Category Name">
      <div class="d-flex justify-content-end">
        <button class="btn btn-secondary me-2" data-bs-dismiss="modal">Cancel</button>
        <button class="btn btn-primary" id="saveCategoryBtn">Save</button>
      </div>
    </div>
  </div>
</div>

<script type="module">
import { createClient } from '../supabase-config.js';
const supabase = createClient();

const tableBody = document.querySelector('#categoriesTable tbody');
const categoryModal = new bootstrap.Modal(document.getElementById('categoryModal'));
const modalTitle = document.getElementById('modalTitle');
const saveBtn = document.getElementById('saveCategoryBtn');
const categoryIdInput = document.getElementById('categoryId');
const categoryNameInput = document.getElementById('categoryName');

// Render a single category row
function renderCategoryRow(category) {
  let row = tableBody.querySelector(`tr[data-id="${category.id}"]`);
  if (!row) {
    row = document.createElement('tr');
    row.dataset.id = category.id;
    tableBody.appendChild(row);
  }
  row.innerHTML = `
    <td>${category.name}</td>
    <td>
      <button class="btn-text editBtn">Edit</button>
      <button class="btn-text deleteBtn">Delete</button>
    </td>
  `;

  row.querySelector('.editBtn').onclick = () => {
    categoryIdInput.value = category.id;
    categoryNameInput.value = category.name;
    modalTitle.textContent = 'Edit Category';
    categoryModal.show();
  };

  row.querySelector('.deleteBtn').onclick = async () => {
    if(confirm('Are you sure you want to delete this category?')) {
      const { error } = await supabase.from('categories').delete().eq('id', category.id);
      if(error) return console.error(error);
      row.remove();
    }
  };
}

// Fetch all categories
async function fetchCategories() {
  const { data, error } = await supabase.from('categories').select('*').order('id', { ascending: true });
  if(error) return console.error(error);

  tableBody.innerHTML = '';
  data.forEach(renderCategoryRow);
}

// Reset modal when adding
document.querySelector('[data-bs-target="#categoryModal"]').addEventListener('click', () => {
  categoryIdInput.value = '';
  categoryNameInput.value = '';
  modalTitle.textContent = 'Add Category';
});

// Save category (Add/Edit)
saveBtn.addEventListener('click', async () => {
  const id = categoryIdInput.value;
  const name = categoryNameInput.value.trim();
  if(!name) return alert('Please enter a category name');

  if(id) {
    const { error } = await supabase.from('categories').update({ name }).eq('id', id);
    if(error) return console.error(error);
    renderCategoryRow({ id, name });
  } else {
    const { data, error } = await supabase.from('categories').insert({ name }).select().single();
    if(error) return console.error(error);
    renderCategoryRow(data);
  }

  categoryModal.hide();
});

// Real-time subscription
supabase.channel('public:categories')
  .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'categories' }, payload => renderCategoryRow(payload.new))
  .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'categories' }, payload => renderCategoryRow(payload.new))
  .on('postgres_changes', { event: 'DELETE', schema: 'public', table: 'categories' }, payload => {
    const row = tableBody.querySelector(`tr[data-id="${payload.old.id}"]`);
    if(row) row.remove();
  })
  .subscribe();

// Initial fetch
fetchCategories();
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
