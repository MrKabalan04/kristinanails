<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Admin Panel - Kristina Nails</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
body { background: #121212; color: #fff; min-height: 100vh; font-family: Arial, sans-serif; }
.navbar { background: #1a1a1a; }
.container { padding-top: 40px; padding-bottom: 40px; }
.card { background: #1e1e1e; border-radius: 12px; padding: 20px; margin-bottom: 20px; }
.btn-primary { background: #ff4d6d; border: none; }
.btn-primary:hover { background: #ff6b87; }
.modal-content { background: #1e1e1e; color: #fff; border-radius: 12px; }
input, select { background: #2a2a2a; color: #fff; border: 1px solid #444; border-radius: 8px; padding: 8px 12px; width: 100%; margin-bottom: 10px; }
table { color: #fff; }
th, td { vertical-align: middle !important; }
.btn-text { background: transparent; border: none; color: #ff4d6d; cursor: pointer; padding: 0 5px; }
.btn-text:hover { text-decoration: underline; }
@media(max-width:576px){
  .container { padding: 20px; }
  table { font-size: 14px; }
  .btn { font-size: 14px; }
}
</style>
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-dark">
  <div class="container">
    <a class="navbar-brand" href="#">Kristina Nails</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarNav">
      <ul class="navbar-nav ms-auto">
        <li class="nav-item"><a class="nav-link" href="#">Services</a></li>
        <li class="nav-item"><a class="nav-link" href="categories.html">Categories</a></li>
        <li class="nav-item"><a class="nav-link" href="admin.html">Logout</a></li>
      </ul>
    </div>
  </div>
</nav>

<div class="container">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2>Manage Services</h2>
    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#serviceModal">+ Add Service</button>
  </div>

  <div class="table-responsive">
    <table class="table table-dark table-striped" id="servicesTable">
      <thead>
        <tr>
          <th>Name</th>
          <th>Price</th>
          <th>Category</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<!-- Add/Edit Service Modal -->
<div class="modal fade" id="serviceModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content p-4">
      <h5 id="modalTitle">Add Service</h5>
      <input type="hidden" id="serviceId">
      <input type="text" id="serviceName" placeholder="Service Name">
      <input type="text" id="servicePrice" placeholder="Price (number, string, or 'half price')">
      <select id="serviceType">
        <option value="regular">Regular</option>
        <option value="/nail">/nail</option>
      </select>
      <select id="serviceCategory"></select>
      <div class="d-flex justify-content-end">
        <button class="btn btn-secondary me-2" data-bs-dismiss="modal">Cancel</button>
        <button class="btn btn-primary" id="saveServiceBtn">Save</button>
      </div>
    </div>
  </div>
</div>

<script type="module">
import { createClient } from '../supabase-config.js';
const supabase = createClient();

const tableBody = document.querySelector('#servicesTable tbody');
const serviceModal = new bootstrap.Modal(document.getElementById('serviceModal'));
const modalTitle = document.getElementById('modalTitle');
const saveBtn = document.getElementById('saveServiceBtn');
const serviceIdInput = document.getElementById('serviceId');
const serviceNameInput = document.getElementById('serviceName');
const servicePriceInput = document.getElementById('servicePrice');
const serviceTypeSelect = document.getElementById('serviceType');
const serviceCategorySelect = document.getElementById('serviceCategory');

let categories = [];

// Fetch categories
async function fetchCategories() {
  const { data, error } = await supabase.from('categories').select('*');
  if(error) return console.error(error);
  categories = data;
  serviceCategorySelect.innerHTML = data.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
}

// Render a single service row
function renderServiceRow(service){
  const categoryName = service.categories?.name || '';
  let row = tableBody.querySelector(`tr[data-id="${service.id}"]`);
  if(!row){
    row = document.createElement('tr');
    row.dataset.id = service.id;
    tableBody.appendChild(row);
  }
  row.innerHTML = `
    <td>${service.name}</td>
    <td>${service.price}</td>
    <td>${categoryName}</td>
    <td>
      <button class="btn-text editBtn">Edit</button>
      <button class="btn-text deleteBtn">Delete</button>
    </td>
  `;
  row.querySelector('.editBtn').onclick = () => {
    serviceIdInput.value = service.id;
    serviceNameInput.value = service.name;
    servicePriceInput.value = service.price.replace('/nail','').replace('$',''); 
    serviceTypeSelect.value = service.price.includes('/nail') ? '/nail' : 'regular';
    serviceCategorySelect.value = service.category_id;
    modalTitle.textContent = 'Edit Service';
    serviceModal.show();
  };
  row.querySelector('.deleteBtn').onclick = async () => {
    if(confirm('Are you sure you want to delete this service?')){
      const { error } = await supabase.from('services').delete().eq('id', service.id);
      if(error) return console.error(error);
      row.remove(); // remove row immediately
    }
  };
}

// Fetch all services and render
async function fetchServices(){
  const { data, error } = await supabase.from('services').select('id,name,price,category_id,categories(name)').order('id', {ascending:true});
  if(error) return console.error(error);
  tableBody.innerHTML = '';
  data.forEach(renderServiceRow);
}

// Reset modal when adding
document.querySelector('[data-bs-target="#serviceModal"]').addEventListener('click', () => {
  serviceIdInput.value = '';
  serviceNameInput.value = '';
  servicePriceInput.value = '';
  serviceTypeSelect.value = 'regular';
  serviceCategorySelect.value = categories[0]?.id || '';
  modalTitle.textContent = 'Add Service';
});

// Save service (Add/Edit)
saveBtn.addEventListener('click', async () => {
  const id = serviceIdInput.value;
  const name = serviceNameInput.value.trim();
  let priceRaw = servicePriceInput.value.trim();
  const type = serviceTypeSelect.value;
  const category_id = serviceCategorySelect.value;
  if(!name || !priceRaw) return alert('Please fill all fields');

  // Only append $ or /nail if the input is numeric
  if(!isNaN(priceRaw)){
    priceRaw += '$';
    if(type === '/nail') priceRaw += '/nail';
  } else if(type === '/nail' && !priceRaw.endsWith('/nail')){
    priceRaw += '/nail';
  }
  const price = priceRaw;

  if(id){
    const { error } = await supabase.from('services').update({name,price,category_id}).eq('id',id);
    if(error) return console.error(error);
    renderServiceRow({id,name,price,category_id,categories:categories.find(c=>c.id==category_id)});
  } else {
    const { data, error } = await supabase.from('services').insert({name,price,category_id}).select().single();
    if(error) return console.error(error);
    renderServiceRow({...data, categories:categories.find(c=>c.id==category_id)});
  }

  serviceModal.hide();
});

// Real-time subscription
supabase.channel('public:services')
  .on('postgres_changes', { event:'INSERT', schema:'public', table:'services' }, payload => renderServiceRow(payload.new))
  .on('postgres_changes', { event:'UPDATE', schema:'public', table:'services' }, payload => renderServiceRow(payload.new))
  .on('postgres_changes', { event:'DELETE', schema:'public', table:'services' }, payload => {
    const row = tableBody.querySelector(`tr[data-id="${payload.old.id}"]`);
    if(row) row.remove();
  })
  .subscribe();

// Initial fetch
fetchCategories().then(fetchServices);
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
